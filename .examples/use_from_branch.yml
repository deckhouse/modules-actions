# –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è actions –∏–∑ –≤–µ—Ç–∫–∏ feat/signing_images
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω—É–∂–Ω–æ –ø–æ–º–µ—Å—Ç–∏—Ç—å –≤ –¥—Ä—É–≥–æ–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ .github/workflows/

name: "–°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª—è —Å –ø–æ–¥–ø–∏—Å—å—é (dev –≤–µ—Ä—Å–∏—è)"

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    name: "–°–±–æ—Ä–∫–∞ –∏ –ø–æ–¥–ø–∏—Å—å –º–æ–¥—É–ª—è"
    
    steps:
      # –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: "üì• Checkout –∫–æ–¥"
        uses: actions/checkout@v4
      
      # –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–∏–∑ –≤–µ—Ç–∫–∏ feat/signing_images)
      - name: "‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
        uses: deckhouse/modules-actions/setup@feat/signing_images
        with:
          registry: registry.deckhouse.io
          registry_login: ${{ secrets.REGISTRY_LOGIN }}
          registry_password: ${{ secrets.REGISTRY_PASSWORD }}
          werf_version: "2.14.3"
      
      # –®–∞–≥ 3: –°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª—è —Å –ø–æ–¥–ø–∏—Å—å—é (–∏–∑ –≤–µ—Ç–∫–∏ feat/signing_images)
      - name: "üèóÔ∏è –°–±–æ—Ä–∫–∞ –º–æ–¥—É–ª—è —Å –ø–æ–¥–ø–∏—Å—å—é"
        uses: deckhouse/modules-actions/build@feat/signing_images
        with:
          # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥—É–ª—è
          module_source: registry.deckhouse.io/deckhouse/ce/modules
          module_name: ${{ vars.MODULE_NAME || 'my-module' }}
          module_tag: ${{ github.ref_name }}
          
          # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (–Ω–æ–≤—ã–µ –≤ –≤–∞—à–µ–π –≤–µ—Ç–∫–µ)
          werf_sign_cert: ${{ secrets.WERF_SIGN_CERT }}
          werf_sign_intermediates: ${{ secrets.WERF_SIGN_INTERMEDIATES }}
          werf_sign_key: ${{ secrets.WERF_SIGN_KEY }}
          
          # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Vault (–Ω–æ–≤—ã–µ –≤ –≤–∞—à–µ–π –≤–µ—Ç–∫–µ)
          vault_addr: ${{ secrets.VAULT_ADDR }}
          vault_role_id: ${{ secrets.VAULT_ROLE_ID }}
          vault_secret_id: ${{ secrets.VAULT_SECRET_ID }}
          transit_secret_engine_path: ${{ secrets.TRANSIT_SECRET_ENGINE_PATH }}
          
          # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
          secondary_repo: ${{ vars.SECONDARY_REPO }}
          source_repo_ssh_key: ${{ secrets.SOURCE_REPO_SSH_KEY }}
          
          # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Svace
          svace_enabled: ${{ github.event.inputs.svace_enabled || 'false' }}
          svace_analyze_host: ${{ secrets.SVACE_ANALYZE_HOST }}
          svace_analyze_ssh_user: ${{ secrets.SVACE_ANALYZE_SSH_USER }}
          svace_analyze_ssh_key: ${{ secrets.SVACE_ANALYZE_SSH_PRIVATE_KEY }}
      
      # –®–∞–≥ 4: CVE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∏–∑ –≤–µ—Ç–∫–∏ feat/signing_images)
      - name: "üîç CVE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ"
        if: github.event_name != 'pull_request'  # –ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –¥–ª—è PR
        uses: deckhouse/modules-actions/cve_scan@feat/signing_images
        with:
          tag: ${{ github.ref_name }}
          tag_type: dev
          module_name: ${{ vars.MODULE_NAME || 'my-module' }}
          dd_url: ${{ secrets.DEFECTDOJO_HOST }}
          dd_token: ${{ secrets.DEFECTDOJO_API_TOKEN }}
          prod_registry: ${{ secrets.PROD_READ_REGISTRY }}
          prod_registry_user: ${{ secrets.PROD_READ_REGISTRY_LOGIN }}
          prod_registry_password: ${{ secrets.PROD_READ_REGISTRY_PASSWORD }}
          dev_registry: ${{ secrets.DEV_REGISTRY }}
          dev_registry_user: ${{ secrets.DEV_REGISTRY_LOGIN }}
          dev_registry_password: ${{ secrets.DEV_REGISTRY_PASSWORD }}
          deckhouse_private_repo: ${{ secrets.DECKHOUSE_PRIVATE_REPO }}

# –í–ê–ñ–ù–û: –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ secrets –≤ —Ü–µ–ª–µ–≤–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
# 
# Secrets –¥–ª—è registry:
# - REGISTRY_LOGIN
# - REGISTRY_PASSWORD
# 
# Secrets –¥–ª—è –ø–æ–¥–ø–∏—Å–∏ (–Ω–æ–≤—ã–µ):
# - WERF_SIGN_CERT
# - WERF_SIGN_INTERMEDIATES  
# - WERF_SIGN_KEY
# 
# Secrets –¥–ª—è Vault (–Ω–æ–≤—ã–µ):
# - VAULT_ADDR
# - VAULT_ROLE_ID
# - VAULT_SECRET_ID
# - TRANSIT_SECRET_ENGINE_PATH
# 
# Secrets –¥–ª—è SSH:
# - SOURCE_REPO_SSH_KEY
# - SVACE_ANALYZE_SSH_PRIVATE_KEY
# 
# Secrets –¥–ª—è CVE —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:
# - DEFECTDOJO_HOST
# - DEFECTDOJO_API_TOKEN
# - PROD_READ_REGISTRY
# - PROD_READ_REGISTRY_LOGIN
# - PROD_READ_REGISTRY_PASSWORD
# - DEV_REGISTRY
# - DEV_REGISTRY_LOGIN
# - DEV_REGISTRY_PASSWORD
# - DECKHOUSE_PRIVATE_REPO
# - SVACE_ANALYZE_HOST
# - SVACE_ANALYZE_SSH_USER
# 
# Variables:
# - MODULE_NAME
# - SECONDARY_REPO
